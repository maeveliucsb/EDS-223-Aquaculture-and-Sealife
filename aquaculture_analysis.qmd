---
title: "aquaculture_analysis"
author: 'Maeve'
date: 11/26/25
format: html
editor: visual
embed-resources: true
page-loading: false
code-fold: show
execute: 
  warning: false
  message: false
toc: TRUE
theme: journal
---

# Introduction

For this assignment, you are tasked with determining which Exclusive Economic Zones (EEZ) on the West Coast of the US are best suited to developing marine aquaculture for several species of oysters and a species of your choice. Suitable locations will be determined based on range of suitable sea surface temperature (SST) and depth values for the species.

To make your workflow generalizable, you must create a function that has the following characteristics:

arguments:
minimum and maximum sea surface temperature
minimum and maximum depth
species name
outputs:
map of EEZ regions colored by amount of suitable area
species name should be included in the map’s title


# Load libraries

```{r}
library(tidyverse)
library(sf)
library(terra)
library(tmap)
library(patchwork)
library(here)
library(dplyr)
```

# Load data

SST files used:

-   `average_annual_sst_2008.tif`

-   `average_annual_sst_2009.tif`

-   `average_annual_sst_2010.tif`

-   `average_annual_sst_2011.tif`

-   `average_annual_sst_2012.tif`

Bathymetry files used:

-   depth.tif

## Exclusive Economic Zones

Exclusive Economic Zones files used:

-   wc_regions_clean.shp

```{r}
# Read in shapefile of EEZs
eez <- st_read(here("data", "wc_regions_clean.shp"))
```

## Sea surface temperature

```{r}
# Read in rasters of sea surface temerpature

sst_2008 <- rast(here("data", "average_annual_sst_2008.tif"))
sst_2009 <- rast(here("data", "average_annual_sst_2009.tif"))
sst_2010 <- rast(here("data", "average_annual_sst_2010.tif"))
sst_2011 <- rast(here("data", "average_annual_sst_2011.tif"))
sst_2012 <- rast(here("data", "average_annual_sst_2012.tif"))
```

## Bathymetry

```{r}
# read in raster for depth
bath <- rast(here("data", "depth.tif"))
```

## Oysters

-   sea surface temperature: 11-30°C

-   depth: 0-70 meters below sea level

## Stack rasters

```{r}
# Use c() to stack
sst_stack <- c(sst_2008, 
              sst_2009, 
              sst_2010,
              sst_2011, 
              sst_2012)
```

## Calculate mean

```{r}
# Get the mean of each of the cell values
sst_mean <- terra::app(sst_stack, mean, na.rm = TRUE)

# Globally subtract 273.15
sst_c_mean <- sst_mean - 273.15
stopifnot(inherits(sst_c_mean, "SpatRaster"))   # subtract 273.15 from every cell
```

## Reproject bathymetry

```{r}
bath <- rast(here("data", "depth.tif"))
bath_reproj <- terra::project(bath, sst_c_mean)
```

Resample the bathymetry raster to the sea surface temperature.

```{r}
# Resample to SST
bath_aligned <- terra::resample(bath_reproj, sst_c_mean, method = "bilinear")

# Check the extent
ext(bath_aligned) == ext(sst_c_mean)

# Check the resolution
res(bath_aligned) == res(sst_2008)
```

Create a matrix of oyster sea surface temperature threshold, and oyster depth range.

```{r}
# Matrix of SST rang
sst_osyter_matrix <- matrix(c(
  -Inf, 11, 0,
  11, 30, 1,
  30, Inf, 0),
ncol = 3,
byrow = TRUE)
  
# Matrix of depth range
depth_oyster_matrix <- matrix(c(
  -Inf, -70, 0,
  -70, 0, 1,
  0, Inf, 0),
  ncol = 3,
  byrow = TRUE
)
```

Reclassify the raster with the matrix.

```{r}
# Reclassify
sst_reclassify <- classify(sst_c_mean, sst_osyter_matrix)
bath_reclassify <- classify(bath_aligned, depth_oyster_matrix)
```

Multiply the rasters by each other.

```{r}
# Multiply the reclassified rasters by eachother
multiplied <- sst_reclassify * bath_reclassify

#reclassufying 0s as NAs
multiplied[multiplied == 0 ] <- NA

```

#making the most suitable area (for oysters?)

```{r}
#cropping suitable cells to EEZ
multiplied_cropped <- crop(multiplied, eez)

#rasterizing
EEZrast <- rasterize(eez, multiplied_cropped, field = "area_km2")

#might be unnecessary
suitable <- mask(multiplied_cropped, EEZrast)
```
# zonal statistics
```{r}
zones_good_oysters <- terra::zonal(multiplied_cropped, 
                                   EEZrast, 
                                   fun = "sum")
#changing names from the inital little mess to 
zones_annotated <- cbind(eez,zones_good_oysters)

zones_oysters_clean <- zones_annotated %>%
  dplyr::select(rgn, area_km2, area_km2.1)%>%
  rename("good oyster spots" = "area_km2.1")


map <- tm_shape(zones_oysters_clean)+
  tm_graticules()+
  tm_polygons(fill = "good oyster spots",
              fill.scale = tm_scale(values = mako (2)),
              fill.legend = tm_legend(title = "Area of suitable oyster habitat (km2)",
                                      posititon = tm_pos_out('right'))) + 
  tm_borders(col = 'black') + 
  tm_title(text = 'suitable habitat for this species in each eez')

map
```

# generalizable workflow
applying the function to geoduck (Panopea abrupta )
Preferred temperature (Ref. 115969): 5.7 - 20.6, mean 12.1 (based on 518 cells).
depth: Benthic; depth range 0 - 110 m

```{r}
min_sst <- 5.7
max_sst <- 20.6
min_depth_m <- 0
max_depth_m <- 110
species_name <- "Panopea abrupta"
```

building it! 
```{r}
climate_envelope <- function(eez, #initial eez file before you did stuff
                             bath, #initial bath file before you transformed it 
                             clim_var2, 
                             sst_stack, 
                             min_sst, #assuming that its already cleaned
                             max_sst,
                             min_depth_m, 
                             max_depth_m, 
                             species_name){
  
  species_name_lower <- species_name |> 
    str_to_lower() |> 
    str_replace_all(" ", "_")
  
  occurences_sf <- occurences |> 
    rename(long = longitude,
           lat = latitude) |> 
    drop_na(long) |> 
    st_as_sf(coords = c("long", "lat"), crs = 4326)
  
  occurences_bbox <- st_bbox(occurences_sf)
  
  clim_crop <- crop(clim_rast, occurences_bbox)
  
  clim_pts <- as_tibble(extract(clim_crop, occurences_sf))
  
  random_pts <- spatSample(clim_rast[[clim_var1]],
                           na.rm = TRUE,
                           size = (nrow(occurences) * 2),
                           as.points = TRUE) |>
    st_as_sf()

  clim_random_pts <- as_tibble(terra::extract(clim_crop, random_pts))
  
  map_1 <- tm_shape(clim_crop[[clim_var1]]) +
    tm_raster(col.scale = tm_scale_continuous(values = "Blues")) +
    tm_shape(occurences_sf) +
    tm_dots(fill = "#3a5a40", size = 0.15) +
    tm_layout(legend.position = tm_pos_in("center", "bottom"),
              legend.orientation = "landscape",
              legend.bg.color = "white")

  map_2 <- tm_shape(clim_crop[[clim_var2]]) +
    tm_raster(col.scale = tm_scale_continuous(values = "-RdYlBu")) +
    tm_shape(occurences_sf) +
    tm_dots(fill = "#3a5a40", size = 0.15) +
    tm_layout(legend.position = tm_pos_in("center", "bottom"),
              legend.orientation = "landscape",
              legend.bg.color = "white")
  
  plot_1 <- ggplot(data = clim_pts, aes_string(x = clim_var1, y = clim_var2)) +
    geom_point(shape = 16, color = "#3a5a40") +
    labs(title = paste("Species climate niche of", str_to_sentence(species_name))) +
    theme_bw()
  
  plot_2 <- ggplot(data = clim_random_pts, aes_string(x = clim_var1, y = clim_var2)) +
    geom_point(shape = 16) +
    labs(y = element_blank(), 
         title = paste("Background climate of", str_to_sentence(species_name))) +
    theme_bw()
  
  assign(paste0(species_name_lower, "_map_1"), map_1, envir = .GlobalEnv)
  assign(paste0(species_name_lower, "_map_2"), map_2, envir = .GlobalEnv)
  assign(paste0(species_name_lower, "_plot_1"), plot_1, envir = .GlobalEnv)
  assign(paste0(species_name_lower, "_plot_2"), plot_2, envir = .GlobalEnv)
  
}
```